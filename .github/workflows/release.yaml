name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags (v1.2.3)

permissions:
  contents: write  # Required to create releases
  packages: write  # Required to publish to GitHub Packages

jobs:
  build-and-release:
    name: Build and Release Package
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.BOT_APP_ID }}
          private-key: ${{ secrets.BOT_APP_PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Build package
        run: uv build

      - name: Publish to GitHub Packages
        env:
          UV_PUBLISH_URL: https://pypi.pkg.github.com/jacaudi/
          UV_PUBLISH_USERNAME: jacaudi
          UV_PUBLISH_PASSWORD: ${{ steps.app-token.outputs.token }}
        run: uv publish

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.tar.gz
            dist/*.whl
          body: |
            ## Installation

            ### From GitHub Packages (Recommended)

            Install directly from the GitHub Packages registry:

            ```bash
            # Using pipx (recommended for CLI tools)
            pipx install ytdl-nfo --index-url https://pypi.pkg.github.com/jacaudi/simple/

            # Using uv
            uv tool install ytdl-nfo --index-url https://pypi.pkg.github.com/jacaudi/simple/

            # Using pip
            pip install ytdl-nfo --index-url https://pypi.pkg.github.com/jacaudi/simple/
            ```

            **Note:** Authentication may be required. See [GitHub Packages authentication](https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-apache-maven-registry#authenticating-to-github-packages).

            ### From GitHub Release Assets

            Download the `.whl` file from the assets below, then:

            ```bash
            # Using pipx (recommended for CLI tools)
            pipx install ytdl_nfo-${{ steps.version.outputs.VERSION }}-py3-none-any.whl

            # Using uv
            uv tool install ytdl_nfo-${{ steps.version.outputs.VERSION }}-py3-none-any.whl

            # Using pip
            pip install ytdl_nfo-${{ steps.version.outputs.VERSION }}-py3-none-any.whl
            ```
          generate_release_notes: true
          draft: false
